<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>ग्राम पंचायत सर्वा · उन्नत डैशबोर्ड + नई सुविधाएँ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf2 100%);
      padding: 24px 20px;
      color: #1e293b;
      line-height: 1.5;
      transition: background-color 0.3s, color 0.3s;
    }
    /* Skeleton, dark mode etc – same as before */
    .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #cbd5e1 50%, #e2e8f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 12px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    body.dark-mode { background: #0f1825; color: #e9edf2; }
    body.dark-mode .masthead { background: #1f2b3a; border-bottom: 3px solid #fbbf24; }
    body.dark-mode .control-ribbon, body.dark-mode .finance-summary, body.dark-mode .chart-card,
    body.dark-mode .table-section, body.dark-mode .excellence-footer, body.dark-mode .feature-card,
    body.dark-mode .fund-card { background: #1f2b3a; border-color: #334155; }
    body.dark-mode .search-module { background: #0f1825; border-color: #fbbf24; }
    body.dark-mode .search-module input { color: #f8fafc; }
    body.dark-mode .pill { background: #334155; color: #e2e8f0; }
    body.dark-mode .pill.active { background: #fbbf24; color: #0f1825; }
    body.dark-mode .legend-item, body.dark-mode .quick-stats, body.dark-mode .feature-card { background: #0f1825; }
    body.dark-mode th { background: #fbbf24; color: #0f1825; }
    body.dark-mode td { border-bottom-color: #334155; }
    body.dark-mode .badge { background: #fbbf24; color: #0f1825; }
    body.dark-mode .donut { border-color: #fbbf24; border-top-color: #f97316; }
    body.dark-mode .toast-notification { background: #334155; color: #f8fafc; }
    body.dark-mode .logo-circle { background: #fbbf24; color: #0f1825; }
    body.dark-mode .modal-content { background: #1f2b3a; color: #f8fafc; }
    body.dark-mode .amount-filter-panel { background: #0f1825; border-color: #fbbf24; }
    body.dark-mode .fund-card { background: #0f1825; }
    .flagship-dashboard { max-width: 1600px; margin: 0 auto; display: flex; flex-direction: column; gap: 24px; }
    .toast-notification { position: fixed; bottom: 30px; right: 30px; background: #0f2a44; color: white; padding: 12px 24px; border-radius: 50px; font-weight: 500; box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 9999; opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
    .toast-notification.show { opacity: 1; transform: translateY(0); }
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); position: relative; border: 2px solid #fbbf24; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }

    /* Header (original) */
    .masthead { background: rgba(15, 42, 68, 0.95); backdrop-filter: blur(10px); border-radius: 40px; padding: 32px 28px; color: white; box-shadow: 0 25px 40px -18px #0f2a44; border: 1px solid rgba(251, 191, 36, 0.3); transition: background 0.3s; }
    .brand-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
    .insignia { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .logo-group { display: flex; align-items: center; gap: 10px; }
    .gov-icon { background: linear-gradient(145deg, #ffffff, #f0f4fa); width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.8rem; color: #0f2a44; box-shadow: 0 6px 12px #00000030; }
    .logo-circle { background: #fbbf24; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 700; color: #0f2a44; box-shadow: 0 4px 8px #00000030; text-transform: uppercase; animation: fadeInUp 0.5s ease; }
    .gov-title h1 { font-weight: 800; font-size: 2rem; letter-spacing: -0.02em; text-shadow: 0 2px 4px rgba(0,0,0,0.3); background: linear-gradient(135deg, #ffffff, #fef9c3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .gov-title .sub { display: flex; flex-wrap: wrap; gap: 22px; margin-top: 6px; font-weight: 400; opacity: 0.95; }
    .commission-tag { background: #fbbf24; color: #0f2a44; border-radius: 40px; padding: 12px 28px; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 10px #00000030; transition: 0.2s; }
    .commission-tag:hover { background: #f59e0b; transform: translateY(-2px); }
    .live-clock { font-size: 1.2rem; background: rgba(255,255,255,0.15); backdrop-filter: blur(5px); border-radius: 40px; padding: 8px 20px; font-weight: 500; }

    .gold-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; margin-top: 32px; }
    .metric-gold { background: rgba(255,255,255,0.15); backdrop-filter: blur(12px); border-radius: 28px; padding: 22px 16px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.25); transition: 0.2s; animation: fadeInUp 0.6s ease; }
    .metric-gold:hover { background: rgba(255,255,255,0.25); transform: translateY(-5px); border-color: #fbbf24; }
    .metric-icon { font-size: 2.4rem; width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 30px; display: flex; align-items: center; justify-content: center; }
    .metric-content h2 { font-size: 2rem; font-weight: 800; line-height: 1.2; }
    .metric-content p { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

    .feature-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .feature-card { background: white; border-radius: 28px; padding: 20px; border: 1px solid #fbbf24; box-shadow: 0 10px 18px -8px rgba(251, 191, 36, 0.3); transition: transform 0.2s, box-shadow 0.2s; animation: fadeInUp 0.7s ease; }
    .feature-card:hover { transform: translateY(-5px); box-shadow: 0 15px 25px -8px #fbbf24; }
    .feature-title { font-size: 1.1rem; font-weight: 600; color: #0f2a44; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .budget-gauge { width: 100%; height: 20px; background: #e2e8f0; border-radius: 30px; overflow: hidden; margin: 8px 0; }
    .gauge-fill { height: 100%; background: linear-gradient(90deg, #fbbf24, #f97316); border-radius: 30px; transition: width 0.4s; }
    .top-project-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #fbbf24; font-size: 0.9rem; }

    /* नया फंड-वार कार्ड रो */
    .fund-summary-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .fund-card { background: white; border-radius: 28px; padding: 18px 20px; border: 1px solid #fbbf24; box-shadow: 0 10px 18px -10px #fbbf2480; display: flex; flex-direction: column; gap: 12px; }
    .fund-card .fund-title { font-weight: 700; font-size: 1.2rem; color: #0f2a44; border-bottom: 2px solid #fbbf24; padding-bottom: 6px; margin-bottom: 4px; }
    .fund-stats { display: flex; flex-wrap: wrap; justify-content: space-between; row-gap: 10px; }
    .fund-stat-item { min-width: 100px; }
    .fund-stat-label { font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }
    .fund-stat-value { font-weight: 700; font-size: 1.3rem; line-height: 1.2; }

    .control-ribbon { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 50px; padding: 14px 24px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 20px; border: 2px solid #fbbf24; box-shadow: 0 6px 14px #fbbf2440; }
    .search-module { display: flex; align-items: center; background: #ffffff; border-radius: 40px; padding: 10px 22px; min-width: 260px; flex: 1 1 260px; border: 1px solid #fbbf24; }
    .search-module i { color: #f97316; margin-right: 10px; }
    .search-module input { border: none; background: transparent; font-size: 1rem; width: 100%; outline: none; }
    .filter-pills { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .pill { background: #fff7e0; border: none; padding: 10px 24px; border-radius: 40px; font-weight: 600; font-size: 0.9rem; color: #7b2c0d; cursor: pointer; transition: 0.15s; display: inline-flex; align-items: center; gap: 8px; }
    .pill.active { background: #fbbf24; color: #0f2a44; }
    #yearFilter, #rowsPerPage { background: #fff7e0; border: none; padding: 10px 28px 10px 20px; border-radius: 40px; font-weight: 600; font-size: 0.9rem; color: #7b2c0d; cursor: pointer; outline: none; }
    .extra-tools { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .extra-btn { background: #fff7e0; border: none; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #7b2c0d; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .extra-btn:hover { background: #fbbf24; color: #0f2a44; transform: scale(1.05); }
    .language-switch { background: #fff7e0; border: none; padding: 10px 18px; border-radius: 40px; font-weight: 600; cursor: pointer; }

    .col-toggle { position: relative; display: inline-block; }
    .col-toggle-content { display: none; position: absolute; right: 0; background: white; border: 1px solid #fbbf24; border-radius: 20px; padding: 12px; z-index: 100; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .col-toggle-content.show { display: block; }
    .col-toggle-content label { display: block; padding: 6px 0; cursor: pointer; }

    .amount-filter-panel {
      background: rgba(255,255,240,0.7);
      backdrop-filter: blur(8px);
      border-radius: 60px;
      padding: 12px 28px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
      border: 1px solid #fbbf24;
      margin-top: 5px;
    }
    .amount-filter-panel label { font-weight: 600; color: #0f2a44; }
    .amount-filter-panel input[type=number] {
      background: white;
      border: 1px solid #fbbf24;
      border-radius: 40px;
      padding: 10px 16px;
      width: 140px;
      font-weight: 500;
    }
    .filter-action-btn {
      background: #0f2a44;
      color: white;
      border: none;
      padding: 10px 28px;
      border-radius: 40px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }
    .filter-action-btn:hover { background: #fbbf24; color: #0f2a44; }

    .insight-panel { display: grid; grid-template-columns: 1fr 1.2fr; gap: 24px; }
    .chart-card { background: white; border-radius: 32px; padding: 16px; border: 1px solid #fbbf24; box-shadow: 0 10px 18px -10px #fbbf2480; }
    .finance-summary { background: white; border-radius: 32px; padding: 16px; border: 1px solid #fbbf24; box-shadow: 0 10px 18px -10px #fbbf2480; }
    .summary-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; font-size: 1rem; color: #0f2a44; }
    .summary-header .chart-download { background: none; border: none; color: #f97316; cursor: pointer; font-size: 1rem; margin-left: 8px; }
    #yearChart { max-height: 140px !important; width: 100% !important; }
    #pieChart { max-height: 130px !important; width: 100% !important; margin-top: 10px; }
    .trend-chart-container { margin-top: 12px; padding: 8px; background: rgba(251,191,36,0.08); border-radius: 24px; }
    #amountTrendChart { max-height: 70px !important; width: 100% !important; }

    .donut-progress { display: flex; flex-direction: column; align-items: center; }
    .donut { width: 90px; height: 90px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.5rem; color: #0f2a44; border: 6px solid #fed7aa; border-top-color: #fbbf24; margin: 0 auto 6px; }
    .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0; }
    .legend-item { display: flex; align-items: center; gap: 8px; background: #fff9f0; padding: 8px 10px; border-radius: 20px; font-size: 0.85rem; }
    .color-dot { width: 14px; height: 14px; border-radius: 20px; }
    .quick-stats { background: #fff9f0; border-radius: 20px; padding: 12px; margin: 12px 0; font-size: 0.85rem; }
    .stat-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #fbbf24; padding: 6px 0; }
    .progress-micro-bar { background: #fed7aa; height: 10px; border-radius: 30px; overflow: hidden; }
    .progress-fill { background: #f97316; height: 10px; width: 0%; border-radius: 30px; transition: width 0.4s; }
    .growth-indicator { font-size: 0.9rem; display: inline-flex; align-items: center; gap: 4px; background: #e6f7e6; padding: 4px 10px; border-radius: 30px; }
    .growth-positive { color: #2e7d32; }
    .growth-negative { color: #c62828; }

    .table-section { background: white; border-radius: 32px; padding: 6px; border: 1px solid #fbbf24; box-shadow: 0 10px 18px -10px #fbbf2480; }
    .table-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px 8px; flex-wrap: wrap; gap: 12px; }
    .table-header h2 { font-weight: 700; font-size: 1.5rem; color: #0f2a44; }
    .badge { background: #fbbf24; color: #0f2a44; padding: 6px 20px; border-radius: 40px; font-weight: 700; }
    .table-scroll { overflow-x: auto; border-radius: 28px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 1300px; }
    th { background: #fbbf24; color: #0f2a44; padding: 14px 10px; font-weight: 600; cursor: pointer; }
    th i { margin-left: 6px; }
    td { padding: 12px 10px; border-bottom: 1px solid #fed7aa; cursor: pointer; transition: background 0.1s; }
    td:hover { background: #fff3cd; }
    tbody tr:nth-child(even) { background: #fffdf7; }
    tbody tr:hover td { background: #fffbeb; }
    .status-super { display: inline-flex; align-items: center; gap: 8px; padding: 4px 14px; border-radius: 40px; font-weight: 600; font-size: 0.75rem; border: 1px solid; }
    .status-super.complete { background: #dcfce7; color: #166534; border-color: #86efac; }
    .status-super.progress { background: #fff3cd; color: #856404; border-color: #ffe69c; }
    tfoot { background: #fef9f4; }
    .grand-total-amt { font-size: 1rem; font-weight: 800; }
    .rupee-cell { text-align: right; font-weight: 600; }

    .pagination-wrapper { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; flex-wrap: wrap; gap: 16px; }
    .rows-selector { display: flex; align-items: center; gap: 8px; }
    .rows-selector select { background: #fff7e0; border: none; padding: 6px 14px; border-radius: 30px; font-weight: 600; color: #7b2c0d; }
    .pagination { display: flex; gap: 6px; }
    .page-btn { background: #fff7e0; border: none; padding: 6px 14px; border-radius: 30px; font-weight: 600; color: #7b2c0d; cursor: pointer; transition: 0.2s; }
    .page-btn.active { background: #fbbf24; color: #0f2a44; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .excellence-footer { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 50px; padding: 16px 24px; border: 2px solid #fbbf24; flex-wrap: wrap; gap: 18px; }
    .footer-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn-icon { background: #0f2a44; color: white; border: none; padding: 10px 24px; border-radius: 40px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn-icon:hover { background: #fbbf24; color: #0f2a44; transform: translateY(-2px); }

    [data-tooltip] { position: relative; cursor: help; }
    [data-tooltip]:before { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #0f2a44; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; white-space: nowrap; display: none; z-index: 1000; }
    [data-tooltip]:hover:before { display: block; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 1000px) { .insight-panel, .feature-grid, .fund-summary-row { grid-template-columns: 1fr; } }
    @media (max-width: 700px) { .gold-stats { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 500px) { .gold-stats { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="flagship-dashboard" id="app">

  <!-- Header -->
  <div class="masthead">
    <div class="brand-row">
      <div class="insignia">
        <div class="gov-icon"><i class="fas fa-university"></i></div>
        <div class="logo-group"><div class="logo-circle">GoB</div><div class="logo-circle">PRD</div></div>
        <div class="gov-title">
          <h1 id="mainHeading">15वीं वित्त + षष्टम राज्य वित्त</h1>
          <div class="sub"><span><i class="fas fa-map-marker-alt"></i> सर्वा | बरबीघा | शेखपुरा</span><span><i class="fas fa-calendar-alt"></i> 2025-26</span></div>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span class="live-clock" id="liveClock"></span>
        <div class="commission-tag" onclick="toggleDarkMode()" tabindex="0" role="button"><i class="fas fa-moon"></i> <span id="darkModeText">डार्क मोड</span></div>
        <button class="language-switch" onclick="toggleLanguage()"><i class="fas fa-language"></i> <span id="langText">English</span></button>
      </div>
    </div>
    <div class="gold-stats" id="metricCards">
      <div class="metric-gold"><span class="metric-icon"><i class="fas fa-tasks"></i></span><div class="metric-content"><h2 id="totalSchemes">0</h2><p id="totalSchemesLabel">कुल योजनाएँ</p></div></div>
      <div class="metric-gold"><span class="metric-icon"><i class="fas fa-check-circle"></i></span><div class="metric-content"><h2 id="completedSchemes">0</h2><p id="completedSchemesLabel">पूर्ण कार्य</p></div></div>
      <div class="metric-gold"><span class="metric-icon"><i class="fas fa-spinner"></i></span><div class="metric-content"><h2 id="progressSchemes">0</h2><p id="progressSchemesLabel">प्रगति पर</p></div></div>
      <div class="metric-gold"><span class="metric-icon"><i class="fas fa-coins"></i></span><div class="metric-content"><h2 id="totalAmount">₹0</h2><p id="totalAmountLabel">कुल परिव्यय</p></div></div>
    </div>
  </div>

  <!-- Feature cards (updated: top 5 projects) -->
  <div class="feature-grid">
    <div class="feature-card">
      <div class="feature-title"><i class="fas fa-chart-line"></i> <span class="budgetTitle">बजट उपयोग</span></div>
      <div class="budget-gauge"><div class="gauge-fill" id="budgetGaugeFill" style="width:0%"></div></div>
      <div style="display: flex; justify-content: space-between;"><span class="usedLabel">उपयोग: <span id="budgetUsed">₹0</span></span><span class="totalLabel">कुल: <span id="budgetTotal">₹0</span></span></div>
      <div style="margin-top: 20px;"><div class="feature-title"><i class="fas fa-chart-pie"></i> <span id="pieTitle">फंड वार वितरण</span> <button class="chart-download" onclick="downloadChart('pieChart','fund_distribution.png')" title="Download PNG"><i class="fas fa-download"></i></button></div><canvas id="pieChart"></canvas></div>
    </div>
    <div class="feature-card">
      <div class="feature-title"><i class="fas fa-crown"></i> <span class="topProjectsTitle">टॉप 5 योजनाएँ (राशि)</span></div>
      <div id="topProjects" style="max-height:200px; overflow-y:auto;"></div>
    </div>
    <div class="feature-card">
      <div class="feature-title"><i class="fas fa-calendar-check"></i> <span class="yearlySuccessTitle">वर्षवार सफलता</span></div>
      <div id="yearlyReport"></div>
    </div>
  </div>

  <!-- नया: फंड-वार सारांश कार्ड -->
  <div class="fund-summary-row">
    <div class="fund-card" id="fund15Card">
      <div class="fund-title"><i class="fas fa-landmark"></i> 15वीं वित्त</div>
      <div class="fund-stats">
        <div class="fund-stat-item"><span class="fund-stat-label">योजनाएँ</span><div class="fund-stat-value" id="fund15Count">0</div></div>
        <div class="fund-stat-item"><span class="fund-stat-label">कुल राशि</span><div class="fund-stat-value" id="fund15Amount">₹0</div></div>
        <div class="fund-stat-item"><span class="fund-stat-label">पूर्ण %</span><div class="fund-stat-value" id="fund15Pct">0%</div></div>
        <div class="fund-stat-item"><span class="fund-stat-label">प्रगति</span><div class="fund-stat-value" id="fund15Progress">0</div></div>
      </div>
    </div>
    <div class="fund-card" id="fundStateCard">
      <div class="fund-title"><i class="fas fa-building"></i> षष्टम राज्य</div>
      <div class="fund-stats">
        <div class="fund-stat-item"><span class="fund-stat-label">योजनाएँ</span><div class="fund-stat-value" id="fundStateCount">0</div></div>
        <div class="fund-stat-item"><span class="fund-stat-label">कुल राशि</span><div class="fund-stat-value" id="fundStateAmount">₹0</div></div>
        <div class="fund-stat-item"><span class="fund-stat-label">पूर्ण %</span><div class="fund-stat-value" id="fundStatePct">0%</div></div>
        <div class="fund-stat-item"><span class="fund-stat-label">प्रगति</span><div class="fund-stat-value" id="fundStateProgress">0</div></div>
      </div>
    </div>
  </div>

  <!-- Control ribbon (अब रीसेट सेटिंग्स बटन के साथ) -->
  <div class="control-ribbon">
    <div class="search-module"><i class="fas fa-search"></i><input type="text" placeholder="कार्य खोजें..." id="searchInput"></div>
    <div class="filter-pills" id="filterPills">
      <button class="pill active" data-filter="all"><i class="fas fa-layer-group"></i> <span class="filterAll">सभी</span></button>
      <button class="pill" data-filter="complete"><i class="fas fa-check"></i> <span class="filterComplete">पूर्ण</span></button>
      <button class="pill" data-filter="progress"><i class="fas fa-clock"></i> <span class="filterProgress">प्रगति पर</span></button>
      <select id="yearFilter"><option value="all">सभी वर्ष</option><option value="2021–22">2021–22</option><option value="2022–23">2022–23</option><option value="2023–24">2023–24</option><option value="2024–25">2024–25</option><option value="2024–2025">2024–2025</option><option value="2025–26">2025–26</option></select>
      <button class="pill" onclick="resetFilters()"><i class="fas fa-undo-alt"></i> <span class="resetLabel">रीसेट</span></button>
    </div>
    <div class="extra-tools">
      <button class="extra-btn" onclick="toggleFullScreen()" title="फुल स्क्रीन"><i class="fas fa-expand"></i></button>
      <!-- नया रीसेट सेटिंग्स बटन -->
      <button class="extra-btn" onclick="resetAllSettings()" title="सभी सेटिंग्स डिफ़ॉल्ट"><i class="fas fa-cog"></i></button>
      <div class="col-toggle" id="colToggle15"><button class="extra-btn" onclick="toggleColDropdown('15')"><i class="fas fa-columns"></i></button><div class="col-toggle-content" id="colDropdown15"><label><input type="checkbox" checked data-col="0"> क्र.</label><label><input type="checkbox" checked data-col="1"> मद</label><label><input type="checkbox" checked data-col="2"> वित्त वर्ष</label><label><input type="checkbox" checked data-col="3"> योजना का नाम</label><label><input type="checkbox" checked data-col="4"> राशि</label><label><input type="checkbox" checked data-col="5"> स्थिति</label></div></div>
      <div class="col-toggle" id="colToggleState"><button class="extra-btn" onclick="toggleColDropdown('state')"><i class="fas fa-columns"></i></button><div class="col-toggle-content" id="colDropdownState"><label><input type="checkbox" checked data-col="0"> क्र.</label><label><input type="checkbox" checked data-col="1"> मद</label><label><input type="checkbox" checked data-col="2"> वित्त वर्ष</label><label><input type="checkbox" checked data-col="3"> योजना का नाम</label><label><input type="checkbox" checked data-col="4"> राशि</label><label><input type="checkbox" checked data-col="5"> स्थिति</label></div></div>
    </div>
  </div>

  <!-- Amount filter panel -->
  <div class="amount-filter-panel">
    <i class="fas fa-filter" style="color: #f97316;"></i>
    <span style="font-weight:600;" id="amountRangeLabel">राशि सीमा :</span>
    <label><span id="minAmountLabel">न्यूनतम</span> (₹)</label>
    <input type="number" id="minAmount" placeholder="0" min="0" step="1000" value="">
    <label><span id="maxAmountLabel">अधिकतम</span> (₹)</label>
    <input type="number" id="maxAmount" placeholder="9999999" min="0" step="1000" value="">
    <button class="filter-action-btn" onclick="applyAmountFilter()"><i class="fas fa-check"></i> <span id="applyFilterBtn">लागू करें</span></button>
    <button class="filter-action-btn" style="background:#f97316;" onclick="clearAmountFilter()"><i class="fas fa-times"></i> <span id="clearFilterBtn">हटाएँ</span></button>
  </div>

  <!-- Insight panel with growth indicator & chart download -->
  <div class="insight-panel">
    <div class="chart-card">
      <div class="summary-header"><h3><i class="fas fa-chart-bar"></i> <span id="barTitle">वित्त वर्षानुसार कार्य</span> <button class="chart-download" onclick="downloadChart('yearChart','yearly_works.png')" title="Download PNG"><i class="fas fa-download"></i></button></h3></div>
      <canvas id="yearChart"></canvas>
    </div>
    <div class="finance-summary">
      <div class="summary-header">
        <h3><i class="fas fa-chart-pie"></i> <span id="summaryTitle">निष्पादन</span></h3>
        <span id="completionPercentBadge">0%</span>
      </div>
      <div class="donut-progress"><div class="donut" id="donutPercent">0%</div><span id="completionFraction">0/0</span></div>
      <div class="legend-grid"><div class="legend-item"><span class="color-dot" style="background:#16a34a;"></span> <span id="legendCompleteLabel">पूर्ण</span>: <span id="legendComplete">0</span></div><div class="legend-item"><span class="color-dot" style="background:#f97316;"></span> <span id="legendProgressLabel">प्रगति</span>: <span id="legendProgress">0</span></div></div>
      <div class="quick-stats" id="quickStats"></div>
      <div class="progress-micro-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <!-- Trend chart + growth indicator -->
      <div class="trend-chart-container">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
          <span style="font-weight:600;" id="trendTitle">वर्षवार व्यय (₹)</span>
          <span id="growthIndicator" class="growth-indicator"><i class="fas fa-chart-line"></i> 0%</span>
        </div>
        <canvas id="amountTrendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- 15th Finance Table -->
  <div class="table-section"><div class="table-header"><h2><i class="fas fa-landmark"></i> <span id="table15Title">15वीं वित्त आयोग</span></h2><div class="badge" id="badge15">0 कार्य</div></div>
    <div class="table-scroll"><table id="table15"><thead><tr><th onclick="sortTable(0, '15')">क्र. <i class="fas fa-sort"></i></th><th onclick="sortTable(1, '15')">मद <i class="fas fa-sort"></i></th><th onclick="sortTable(2, '15')">वित्त वर्ष <i class="fas fa-sort"></i></th><th onclick="sortTable(3, '15')">योजना का नाम <i class="fas fa-sort"></i></th><th onclick="sortTable(4, '15')">राशि <i class="fas fa-sort"></i></th><th>स्थिति</th></tr></thead><tbody id="table15Body"></tbody><tfoot><tr><td colspan="5" class="grand-total-label">कुल</td><td class="rupee-cell grand-total-amt" id="footer15Total">₹0</td></tr></tfoot></table></div>
    <div class="pagination-wrapper" id="paginationWrapper15"><div class="rows-selector"><span id="rowsLabel15">पंक्तियाँ:</span><select id="rowsPerPage15" onchange="changeRowsPerPage('15')"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option></select></div><div class="pagination" id="pagination15"></div></div>
  </div>

  <!-- State Finance Table -->
  <div class="table-section"><div class="table-header"><h2><i class="fas fa-building"></i> <span id="tableStateTitle">षष्टम राज्य वित्त</span></h2><div class="badge" id="badgeState">0 कार्य</div></div>
    <div class="table-scroll"><table id="tableState"><thead><tr><th onclick="sortTable(0, 'state')">क्र. <i class="fas fa-sort"></i></th><th onclick="sortTable(1, 'state')">मद <i class="fas fa-sort"></i></th><th onclick="sortTable(2, 'state')">वित्त वर्ष <i class="fas fa-sort"></i></th><th onclick="sortTable(3, 'state')">योजना का नाम <i class="fas fa-sort"></i></th><th onclick="sortTable(4, 'state')">राशि <i class="fas fa-sort"></i></th><th>स्थिति</th></tr></thead><tbody id="tableStateBody"></tbody><tfoot><tr><td colspan="5" class="grand-total-label">कुल</td><td class="rupee-cell grand-total-amt" id="footerStateTotal">₹0</td></tr></tfoot></table></div>
    <div class="pagination-wrapper" id="paginationWrapperState"><div class="rows-selector"><span id="rowsLabelState">पंक्तियाँ:</span><select id="rowsPerPageState" onchange="changeRowsPerPage('state')"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option></select></div><div class="pagination" id="paginationState"></div></div>
  </div>

  <!-- Footer -->
  <div class="excellence-footer"><div><i class="fas fa-check-double"></i> पंचायत सर्वा · <span id="lastUpdated"></span><br>Created By Aman Kumar | नई सुविधाएँ: फंड सारांश, वृद्धि दर, टॉप 5, चार्ट डाउनलोड</div><div class="footer-actions"><button class="btn-icon" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV</button><button class="btn-icon" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Excel</button><button class="btn-icon" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn-icon" onclick="window.print()"><i class="fas fa-print"></i> <span id="printLabel">प्रिंट</span></button></div></div>

  <!-- Toast & Modal -->
  <div id="toast" class="toast-notification"></div>
  <div id="projectModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal()">&times;</span><h3 id="modalTitle">योजना का विवरण</h3><p><strong id="modalFundLabel">मद:</strong> <span id="modalFund"></span></p><p><strong id="modalYearLabel">वित्त वर्ष:</strong> <span id="modalYear"></span></p><p><strong id="modalDescLabel">योजना का नाम:</strong> <span id="modalDesc"></span></p><p><strong id="modalAmountLabel">राशि:</strong> <span id="modalAmount"></span></p><p><strong id="modalStatusLabel">स्थिति:</strong> <span id="modalStatus"></span></p></div></div>
</div>

<script>
  // ---------- Complete schemes data (24+22) – same as before, but keep it full ----------
  const schemes = [ /* full data */ 
    { fund: "15वीं वित्त आयोग", year: "2021–22", desc: "ग्राम पंचायत सर्वा के ग्राम सर्वा के वार्षिक सं0–07 में बौद्धी पोखर के चारों तरफ मिट्टी भराई एवं खरंजीकरण कार्य।", amount: 1096700, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2021–22", desc: "ग्राम पंचायत सर्वा के ग्राम सर्वा में परमेश्वर साथ से सिभेक्षण महत्ता तक पीठसी0सी0 ढलाई कार्य।", amount: 319100, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2022–23", desc: "ग्राम सर्वा में गेट्टीनी पैन पुल से चादीपुर तक पैन सफाई का मिनांग कार्य।", amount: 1156700, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के ग्राम जमालपुर के वार्षिक सं0–12 में अर्जुन पंडित के घर से विद्रोह कर मांडी के घर तक नाली ढक्कन सहित मिनांग कार्य।", amount: 831000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के ग्राम सर्वा बौद्धी पोखर पर खुला जिम्न का मिनांग कार्य।", amount: 500000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के वार्षिक सं0–06 एवं 07 में महेन्द्र सिंह के घर से ओमन सिंह के घर तक नाली एवं पीठसी0सी0 ढलाई कार्य।", amount: 585800, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा में डस्टवीन 2684 घर के लिए 180 रूपये प्रति जोड़ा।", amount: 500000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम पंचायत सर्वा के वार्षिक सं0–09 में हरगोबिंद यादव के निकट सार्वजनिक कुर्आ का जीणीढ़ार का कार्य।", amount: 74300, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम पंचायत सर्वा के वार्षिक सं0–11 में अजीत पासवान के घर के निकट कुर्आ का जीणीढ़ार का कार्य।", amount: 74300, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम पंचायत सर्वा में किसान भवन पर वर्षा जल संचयन का कार्य।", amount: 110000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम पंचायत सर्वा के ग्राम मिर्जापुर के वार्षिक सं0–05 में अशोक सिह के घर से जनहित पुस्तकालय तक ढक्कन सहित नाली एवं पीठसी0सी0 ढलाई कार्य।", amount: 705000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम पंचायत सर्वा के ग्राम राजीरा के वार्षिक सं0–01 में चम्पक पासवान के घर से नगीना पासवान के घर तक ढक्कन सहित नाली एवं पीठसी0सी0 सड़क का निर्माण कार्य।", amount: 545300, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम राजीरा के वार्षिक सं0–04 के अनुसूचित टोला में सामुदायिक भवन का निर्माण कार्य।", amount: 800000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2023–24", desc: "ग्राम राजीरा के वार्षिक सं0–02 में बजरंगवली मंदिर से मरारी तक ईट सेलिंग एवं पीठसी0सी0 ढलाई का कार्य।", amount: 714400, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2024–25", desc: "ग्राम पंचायत सर्वा के वार्षिक सं0–01 से 04 तक स्ट्रीट लाईट का अध्यक्षपण का कार्य।", amount: 552044, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2024–25", desc: "ग्राम पंचायत सर्वा के वार्षिक सं0–08 में पुस्तकालय के लिए पुस्तक एवं फर्नीचर का क्रय का कार्य।", amount: 450000, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2024–25", desc: "ग्राम पंचायत सर्वा के उच्च माध्यमिक विद्यालय सर्वा के आगे गाइट वॉल के साथ पेयर ब्लॉक निर्माण कार्य।", amount: 987100, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2024–25", desc: "ग्राम पंचायत सर्वा के लालूनगर में सार्वजनिक कुर्आ का जिगोईढ़ार का कार्य।", amount: 74300, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2024–25", desc: "ग्राम पंचायत सर्वा के लालूनगर में सामुदायिक शौचालय का मर्मती कार्य।", amount: 98900, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2025–26", desc: "ग्राम मिर्जापुर में संजीव ढाकी के घर से भीम मांडी के घर तक पीठसी0सी0 ढलाई का कार्य।", amount: 532900, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2025–26", desc: "ग्राम मिर्जापुर के कोडिया आहार में छठ घाट का निर्माण कार्य।", amount: 550600, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2025–26", desc: "ग्राम पंचायत सर्वा में WPU का मर्मती का कार्य।", amount: 129800, status: "पूर्ण" },
    { fund: "15वीं वित्त आयोग", year: "2025–26", desc: "ग्राम सर्वा में खिलु सिंह के खेत से निर्भर सिंह के खेत होते हुए देवन महत्तो के खेत तक ईट सोलिंग एवं पीठसी0सी0 ढलाई का कार्य।", amount: 598400, status: "कार्य प्रगति पर" },
    { fund: "15वीं वित्त आयोग", year: "2025–26", desc: "ग्राम सर्वा में राजीव सिंह के घर से संतोष सिंह के घर तक ढक्कन सहित नाली एवं पीठसी0सी0 ढलाई का कार्य।", amount: 479200, status: "कार्य प्रगति पर" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम सर्वा में रामेश्वर सिंह के खेत से आलोक सिंह के घर तक एवं शंकर सिंह के घर से रामेश्वर सिंह के घर तक मिट्टी भराई खड़ीजकरण एवं पी0सी0सी0 ढलाई कार्य ।", amount: 527400, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा में किसान भवन का जीणांद्वार का कार्य ।", amount: 216500, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के ग्राम मिजापुर के वार्ड सं0–03 में मनोज सिंह के घर से सिपाही जी के घर होते हुए अक्कम महत्ते के घर तक पेवर ब्लॉक सोलिंग एवं नाली निर्माण कार्य ।", amount: 676500, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के वार्ड सं0–11 में हरिजन सामुदायिक भवन का मर्मती कार्य ।", amount: 284200, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम सर्वा में सीलालाल महत्ते के खेत के नजदीक पैन में पुलिया का निर्माण कार्य ।", amount: 289000, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के ग्राम सर्वा में राजो वाब के पास पुलिया का निर्माण कार्य ।", amount: 284100, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम पंचायत सर्वा के ग्राम सर्वा के वार्ड सं0–10 में रामदेव रविदास के घर से ब्रह्मदेव रविदास के घर तक एवं श्यामली दास के घर से सुयादेव दास के घर तक ढक्कन सहित नाली निर्माण कार्य ।", amount: 271300, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2022–23", desc: "ग्राम सर्वा में भैरो स्थान के पास पैन में पुलिया का निर्माण कार्य ।", amount: 289000, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2023–24", desc: "ग्राम पंचायत सर्वा के ग्राम जमालपुर के वार्ड सं0–12 में अपशिष्ट प्रसंस्करण इकाई WPU का निर्माण कार्य ।", amount: 817700, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम सर्वा के वार्ड सं0–06 में नरेश महत्ते के दलान के नजदीक नाला का निर्माण कार्य ।", amount: 615500, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम सर्वा के वार्ड सं0–06 में अनिल सिंह के निकट पैन में पुल का निर्माण कार्य ।", amount: 409100, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम सर्वा के वार्ड सं0–09 में पोसन यादव के घर से काकू यादव के घर तक नाली एवं पी0सी0घी0 ढलाई का निर्माण कार्य ।", amount: 656100, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम पंचायत सर्वा के लालूनगर में छत्तेदार चबुतरा का जीणांद्वार का कार्य ।", amount: 197100, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम सर्वा के वार्ड सं0–06 में सुरेन्द्र पासवान के घर से प्रवीण पासवान के घर तक चंदन पासवान के घर से अनिल पासवान के घर तक पी0सी0सी0 ढलाई एवं नाली निर्माण कार्य ।", amount: 198200, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम मिजापुर में नंदु मांडी के घर से प्रकाश चौधरी के घर तक ढक्कन सहित नाली मर्मती एवं पी0सी0घी0 ढलाई कार्य ।", amount: 387100, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम सर्वा में विष्टरी स्थान से अनुसूचित टोला जाने वाली सड़क तक पी0सी0सी0 ढलाई कार्य ।", amount: 429700, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2024–2025", desc: "ग्राम जमालपुर में भूषण पंडित के घर से रामजी यादव के घर तक एवं अरूण श्रा के घर से वकील साहब के घर तक ढक्कन सहित नाली एवं परमेश्वर पंडित के घर से विजय कुमार के घर तक पी0सी0सी0 ढलाई कार्य ।", amount: 399700, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2025–26", desc: "ग्राम पंचायत सर्वा के ग्राम सर्वा में मेन रोड पर मुख्य द्वार का निर्माण कार्य ।", amount: 507400, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2025–26", desc: "ग्राम पंचायत सर्वा के वार्ड सं0–08 में सामुदायिक भवन का मर्मती कार्य ।", amount: 440100, status: "पूर्ण" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2025–26", desc: "ग्राम सर्वा में लुटन सिंह के घर से अनिल सिंह के घर होते हुए राजेन्द्र सिंह के घर तक पी0सी0घी0 ढलाई कार्य ।", amount: 209700, status: "कार्य प्रगति पर" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2025–26", desc: "ग्राम सर्वा में युजनंदन ठाकुर के घर से अनिल शर्मा के घर तक एवं सत्यनारायण कुमार के घर से रामबृक्ष ठाकुर के घर तक ढक्कन सहित नाली एवं पी0सी0घी0 ढलाई कार्य ।", amount: 109900, status: "कार्य प्रगति पर" },
    { fund: "षष्टम राज्य वित्त आयोग", year: "2025–26", desc: "ग्राम सर्वा में लुटन सिंह के घर से अनिल सिंह के घर होते हुए राजेन्द्र सिंह के घर तक नाली निर्माण कार्य ।", amount: 195600, status: "कार्य प्रगति पर" }
  ];

  // Global variables
  let currentSort = { table: null, col: 0, asc: true };
  let chartInstance, pieChartInstance, trendChartInstance;
  let currentPage15 = 1, currentPageState = 1, rowsPerPage15 = 10, rowsPerPageState = 10, currentLanguage = 'hi';
  let minAmountFilter = null, maxAmountFilter = null;

  // ========== Helper Functions ==========
  function showToast(message, duration = 3000) {
    const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), duration);
  }
  function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); showToast(currentLanguage==='hi'?'फुल स्क्रीन टॉगल':'Full screen toggled'); }
  function toggleColDropdown(table) { document.getElementById(`colDropdown${table==='15'?'15':'State'}`).classList.toggle('show'); }
  function updateClock() { const now = new Date(); document.getElementById('liveClock').innerHTML = `<i class="far fa-clock"></i> ${now.toLocaleTimeString('hi-IN',{hour12:false})}`; }
  setInterval(updateClock,1000);
  function setLastUpdated() { document.getElementById('lastUpdated').innerText = new Date().toLocaleString('hi-IN'); }
  function formatMoney(n) { let [int,frac]=n.toFixed(2).split('.'); let last=int.slice(-3), rest=int.slice(0,-3); if(rest) last=','+last; return '₹'+rest.replace(/\B(?=(\d{2})+(?!\d))/g,',')+last+'.'+frac; }

  // Column visibility
  function updateColumnVisibility(tableId) {
    const table = document.getElementById(tableId === '15' ? 'table15' : 'tableState');
    const checkboxes = document.querySelectorAll(`#colDropdown${tableId === '15' ? '15' : 'State'} input[type="checkbox"]`);
    const headers = table.querySelectorAll('thead th');
    checkboxes.forEach((cb, idx) => {
      const col = parseInt(cb.dataset.col);
      const visible = cb.checked;
      table.querySelectorAll('tr').forEach(row => {
        if (row.cells[col]) row.cells[col].style.display = visible ? '' : 'none';
      });
      if (headers[col]) headers[col].style.display = visible ? '' : 'none';
    });
    saveSettings();
  }

  // Pagination render
  function renderPagination(totalRows, currentPage, tableType, rowsPerPage) {
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    const paginationDiv = document.getElementById(tableType === '15' ? 'pagination15' : 'paginationState');
    if (totalPages <= 1) { paginationDiv.innerHTML = ''; return; }
    let html = `<button class="page-btn" onclick="changePage('${tableType}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage('${tableType}', ${i})">${i}</button>`;
      else if (i === currentPage - 3 || i === currentPage + 3)
        html += `<button class="page-btn" disabled>...</button>`;
    }
    html += `<button class="page-btn" onclick="changePage('${tableType}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
    paginationDiv.innerHTML = html;
  }

  // Render table
  function renderTable(tbodyId, data, page, tableType, rowsPerPage) {
    const tbody = document.getElementById(tbodyId);
    const start = (page - 1) * rowsPerPage, end = start + rowsPerPage;
    const pageData = data.slice(start, end);
    tbody.innerHTML = '';
    pageData.forEach((s, i) => {
      let cls = s.status === 'पूर्ण' ? 'complete' : 'progress';
      let ico = s.status === 'पूर्ण' ? 'fa-check' : 'fa-clock';
      let shortDesc = s.desc.length > 50 ? s.desc.substring(0, 50) + '...' : s.desc;
      tbody.innerHTML += `<tr onclick="showProjectModal('${s.fund.replace(/'/g, "\\'")}', '${s.year}', '${s.desc.replace(/'/g, "\\'")}', ${s.amount}, '${s.status}')">
        <td>${start + i + 1}</td><td>${s.fund}</td><td>${s.year}</td>
        <td data-tooltip="${s.desc}">${shortDesc}</td>
        <td class="rupee-cell">${formatMoney(s.amount)}</td>
        <td><span class="status-super ${cls}"><i class="fas ${ico}"></i> ${s.status}</span></td>
      </tr>`;
    });
    renderPagination(data.length, page, tableType, rowsPerPage);
    setTimeout(() => updateColumnVisibility(tableType === '15' ? '15' : 'state'), 50);
  }

  function changePage(tableType, newPage) { if (tableType === '15') currentPage15 = newPage; else currentPageState = newPage; filterData(); }
  function changeRowsPerPage(tableType) {
    if (tableType === '15') { rowsPerPage15 = parseInt(document.getElementById('rowsPerPage15').value); currentPage15 = 1; }
    else { rowsPerPageState = parseInt(document.getElementById('rowsPerPageState').value); currentPageState = 1; }
    filterData(); saveSettings();
  }

  // ========== Update Metrics (includes fund cards, growth, top5) ==========
  function updateMetrics() {
    // Use filtered data (so fund cards also respect current filters)
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.querySelector('.pill.active')?.getAttribute('data-filter') || 'all';
    const yearFilter = document.getElementById('yearFilter').value;
    const min = minAmountFilter !== null ? minAmountFilter : (document.getElementById('minAmount').value ? Number(document.getElementById('minAmount').value) : null);
    const max = maxAmountFilter !== null ? maxAmountFilter : (document.getElementById('maxAmount').value ? Number(document.getElementById('maxAmount').value) : null);
    const filtered = schemes.filter(s => {
      const matchSearch = s.desc.toLowerCase().includes(search) || s.fund.toLowerCase().includes(search);
      const matchStatus = statusFilter === 'all' ? true : (statusFilter === 'complete' ? s.status === 'पूर्ण' : s.status === 'कार्य प्रगति पर');
      const matchYear = yearFilter === 'all' ? true : s.year === yearFilter;
      const matchAmount = (min === null || s.amount >= min) && (max === null || s.amount <= max);
      return matchSearch && matchStatus && matchYear && matchAmount;
    });

    // Overall metrics
    const total = filtered.length;
    const completed = filtered.filter(s => s.status === 'पूर्ण').length;
    const progress = total - completed;
    const totalAmt = filtered.reduce((a, s) => a + s.amount, 0);
    document.getElementById('totalSchemes').innerText = total;
    document.getElementById('completedSchemes').innerText = completed;
    document.getElementById('progressSchemes').innerText = progress;
    document.getElementById('totalAmount').innerText = formatMoney(totalAmt);

    const perc = total ? ((completed / total) * 100).toFixed(1) : 0;
    document.getElementById('donutPercent').innerText = perc + '%';
    document.getElementById('completionFraction').innerText = completed + '/' + total;
    document.getElementById('completionPercentBadge').innerText = perc + '%';
    document.getElementById('legendComplete').innerText = completed;
    document.getElementById('legendProgress').innerText = progress;
    document.getElementById('progressFill').style.width = perc + '%';

    const avg = completed ? (filtered.filter(s => s.status === 'पूर्ण').reduce((a, s) => a + s.amount, 0) / completed) : 0;
    const maxS = filtered.length ? filtered.reduce((a, b) => a.amount > b.amount ? a : b) : { amount: 0 };
    const minS = filtered.length ? filtered.reduce((a, b) => a.amount < b.amount ? a : b) : { amount: 0 };
    const completedAmt = filtered.filter(s => s.status === 'पूर्ण').reduce((a, s) => a + s.amount, 0);
    document.getElementById('quickStats').innerHTML = `
      <div class="stat-row"><span>${currentLanguage === 'hi' ? 'औसत पूर्ण' : 'Avg Completed'}</span> <strong>${formatMoney(avg)}</strong></div>
      <div class="stat-row"><span>${currentLanguage === 'hi' ? 'अधिकतम' : 'Max'}</span> <strong>${formatMoney(maxS.amount)}</strong></div>
      <div class="stat-row"><span>${currentLanguage === 'hi' ? 'न्यूनतम' : 'Min'}</span> <strong>${formatMoney(minS.amount)}</strong></div>
      <div class="stat-row"><span>${currentLanguage === 'hi' ? 'कुल पूर्ण' : 'Total Completed'}</span> <strong>${formatMoney(completedAmt)}</strong></div>`;

    document.getElementById('budgetTotal').innerText = formatMoney(totalAmt);
    document.getElementById('budgetUsed').innerText = formatMoney(completedAmt);
    document.getElementById('budgetGaugeFill').style.width = totalAmt ? (completedAmt / totalAmt * 100) + '%' : '0%';

    // Top 5 projects (by amount)
    const top5 = [...filtered].sort((a, b) => b.amount - a.amount).slice(0, 5);
    document.getElementById('topProjects').innerHTML = top5.map(s => `<div class="top-project-item"><span data-tooltip="${s.desc}">${s.desc.substring(0, 30)}...</span> <strong>${formatMoney(s.amount)}</strong></div>`).join('');

    // Yearly success
    const years = [...new Set(filtered.map(s => s.year))].sort();
    document.getElementById('yearlyReport').innerHTML = years.map(y => {
      let ty = filtered.filter(s => s.year === y).length, cy = filtered.filter(s => s.year === y && s.status === 'पूर्ण').length, rate = ty ? ((cy / ty) * 100).toFixed(0) : 0;
      return `<div class="stat-row"><span>${y}</span> <strong>${rate}%</strong></div>`;
    }).join('');

    // Fund-wise cards
    const f15 = filtered.filter(s => s.fund === '15वीं वित्त आयोग');
    const fState = filtered.filter(s => s.fund === 'षष्टम राज्य वित्त आयोग');
    document.getElementById('fund15Count').innerText = f15.length;
    document.getElementById('fund15Amount').innerText = formatMoney(f15.reduce((a,s)=>a+s.amount,0));
    const comp15 = f15.filter(s=>s.status==='पूर्ण').length;
    document.getElementById('fund15Pct').innerText = f15.length ? ((comp15/f15.length)*100).toFixed(1)+'%' : '0%';
    document.getElementById('fund15Progress').innerText = f15.length - comp15;

    document.getElementById('fundStateCount').innerText = fState.length;
    document.getElementById('fundStateAmount').innerText = formatMoney(fState.reduce((a,s)=>a+s.amount,0));
    const compState = fState.filter(s=>s.status==='पूर्ण').length;
    document.getElementById('fundStatePct').innerText = fState.length ? ((compState/fState.length)*100).toFixed(1)+'%' : '0%';
    document.getElementById('fundStateProgress').innerText = fState.length - compState;

    // Trend chart & growth
    const yearLabels = years;
    const yearAmounts = yearLabels.map(y => filtered.filter(s => s.year === y).reduce((acc, s) => acc + s.amount, 0));
    if (trendChartInstance) trendChartInstance.destroy();
    const trendCtx = document.getElementById('amountTrendChart').getContext('2d');
    trendChartInstance = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: yearLabels,
        datasets: [{
          label: currentLanguage === 'hi' ? 'कुल व्यय (₹)' : 'Total Expenditure (₹)',
          data: yearAmounts,
          borderColor: '#f97316',
          backgroundColor: 'rgba(249,115,22,0.1)',
          tension: 0.2,
          fill: true,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => '₹ ' + ctx.raw.toLocaleString('hi-IN') } } },
        scales: { y: { ticks: { callback: v => '₹' + (v / 1e5).toFixed(1) + 'L' } } }
      }
    });

    // Year-over-year growth (latest vs previous)
    let growth = 0;
    if (yearAmounts.length >= 2) {
      const latest = yearAmounts[yearAmounts.length-1];
      const prev = yearAmounts[yearAmounts.length-2];
      growth = prev ? ((latest - prev) / prev * 100) : 0;
    }
    const growthSpan = document.getElementById('growthIndicator');
    growthSpan.innerHTML = `<i class="fas fa-chart-line"></i> ${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`;
    growthSpan.className = `growth-indicator ${growth >= 0 ? 'growth-positive' : 'growth-negative'}`;
  }

  // Render bar & pie charts (using overall data for pie, but we can also use filtered? Keep overall for pie)
  function renderCharts() {
    const years = [...new Set(schemes.map(s => s.year))].sort();
    const counts = years.map(y => schemes.filter(s => s.year === y).length);
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(document.getElementById('yearChart'), {
      type: 'bar',
      data: { labels: years, datasets: [{ label: currentLanguage === 'hi' ? 'कार्यों की संख्या' : 'Number of Works', data: counts, backgroundColor: '#fbbf24', borderRadius: 8 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#fed7aa' } } } }
    });
    const fund15Total = schemes.filter(s => s.fund === '15वीं वित्त आयोग').reduce((a, s) => a + s.amount, 0);
    const fundStateTotal = schemes.filter(s => s.fund === 'षष्टम राज्य वित्त आयोग').reduce((a, s) => a + s.amount, 0);
    if (pieChartInstance) pieChartInstance.destroy();
    pieChartInstance = new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: {
        labels: [currentLanguage === 'hi' ? '15वीं वित्त' : '15th Finance', currentLanguage === 'hi' ? 'राज्य वित्त' : 'State Finance'],
        datasets: [{ data: [fund15Total, fundStateTotal], backgroundColor: ['#fbbf24', '#f97316'], borderWidth: 0 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
  }

  // Filter data and update everything
  function filterData() {
    updateMetrics();   // recalc everything based on filters
    // Also update table footers and badges
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.querySelector('.pill.active')?.getAttribute('data-filter') || 'all';
    const yearFilter = document.getElementById('yearFilter').value;
    const min = minAmountFilter !== null ? minAmountFilter : (document.getElementById('minAmount').value ? Number(document.getElementById('minAmount').value) : null);
    const max = maxAmountFilter !== null ? maxAmountFilter : (document.getElementById('maxAmount').value ? Number(document.getElementById('maxAmount').value) : null);
    const filtered = schemes.filter(s => {
      const matchSearch = s.desc.toLowerCase().includes(search) || s.fund.toLowerCase().includes(search);
      const matchStatus = statusFilter === 'all' ? true : (statusFilter === 'complete' ? s.status === 'पूर्ण' : s.status === 'कार्य प्रगति पर');
      const matchYear = yearFilter === 'all' ? true : s.year === yearFilter;
      const matchAmount = (min === null || s.amount >= min) && (max === null || s.amount <= max);
      return matchSearch && matchStatus && matchYear && matchAmount;
    });
    const f15 = filtered.filter(s => s.fund === '15वीं वित्त आयोग');
    const fState = filtered.filter(s => s.fund === 'षष्टम राज्य वित्त आयोग');
    if (currentPage15 > Math.ceil(f15.length / rowsPerPage15)) currentPage15 = 1;
    if (currentPageState > Math.ceil(fState.length / rowsPerPageState)) currentPageState = 1;
    renderTable('table15Body', f15, currentPage15, '15', rowsPerPage15);
    renderTable('tableStateBody', fState, currentPageState, 'state', rowsPerPageState);
    document.getElementById('footer15Total').innerText = formatMoney(f15.reduce((a, s) => a + s.amount, 0));
    document.getElementById('footerStateTotal').innerText = formatMoney(fState.reduce((a, s) => a + s.amount, 0));
    document.getElementById('badge15').innerText = f15.length + (currentLanguage === 'hi' ? ' कार्य' : ' works');
    document.getElementById('badgeState').innerText = fState.length + (currentLanguage === 'hi' ? ' कार्य' : ' works');
    showToast(currentLanguage === 'hi' ? 'फ़िल्टर लागू' : 'Filter applied');
  }

  // Reset filters (but keep settings)
  function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-filter="all"]').classList.add('active');
    document.getElementById('yearFilter').value = 'all';
    document.getElementById('minAmount').value = ''; document.getElementById('maxAmount').value = '';
    minAmountFilter = null; maxAmountFilter = null;
    currentPage15 = 1; currentPageState = 1;
    filterData();
    showToast(currentLanguage === 'hi' ? 'सभी फ़िल्टर हटे' : 'All filters reset');
  }
  function applyAmountFilter() {
    minAmountFilter = document.getElementById('minAmount').value ? Number(document.getElementById('minAmount').value) : null;
    maxAmountFilter = document.getElementById('maxAmount').value ? Number(document.getElementById('maxAmount').value) : null;
    currentPage15 = 1; currentPageState = 1;
    filterData();
  }
  function clearAmountFilter() {
    document.getElementById('minAmount').value = ''; document.getElementById('maxAmount').value = '';
    minAmountFilter = null; maxAmountFilter = null;
    currentPage15 = 1; currentPageState = 1;
    filterData();
  }

  // Sorting
  function sortTable(col, tableId) {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.querySelector('.pill.active')?.getAttribute('data-filter') || 'all';
    const yearFilter = document.getElementById('yearFilter').value;
    const min = minAmountFilter !== null ? minAmountFilter : (document.getElementById('minAmount').value ? Number(document.getElementById('minAmount').value) : null);
    const max = maxAmountFilter !== null ? maxAmountFilter : (document.getElementById('maxAmount').value ? Number(document.getElementById('maxAmount').value) : null);
    const filtered = schemes.filter(s => {
      const matchSearch = s.desc.toLowerCase().includes(search) || s.fund.toLowerCase().includes(search);
      const matchStatus = statusFilter === 'all' ? true : (statusFilter === 'complete' ? s.status === 'पूर्ण' : s.status === 'कार्य प्रगति पर');
      const matchYear = yearFilter === 'all' ? true : s.year === yearFilter;
      const matchAmount = (min === null || s.amount >= min) && (max === null || s.amount <= max);
      return matchSearch && matchStatus && matchYear && matchAmount;
    });
    let data = tableId === '15' ? filtered.filter(s => s.fund === '15वीं वित्त आयोग') : filtered.filter(s => s.fund === 'षष्टम राज्य वित्त आयोग');
    const asc = currentSort.table === tableId && currentSort.col === col ? !currentSort.asc : true;
    currentSort = { table: tableId, col, asc };
    data.sort((a, b) => {
      let aVal, bVal;
      if (col === 1) { aVal = a.fund; bVal = b.fund; }
      else if (col === 2) { aVal = a.year; bVal = b.year; }
      else if (col === 3) { aVal = a.desc; bVal = b.desc; }
      else if (col === 4) { aVal = a.amount; bVal = b.amount; }
      else if (col === 5) { aVal = a.status; bVal = b.status; }
      else return 0;
      if (typeof aVal === 'string') aVal = aVal.toLowerCase();
      if (typeof bVal === 'string') bVal = bVal.toLowerCase();
      if (asc) return aVal > bVal ? 1 : -1;
      else return aVal < bVal ? 1 : -1;
    });
    if (tableId === '15') currentPage15 = 1; else currentPageState = 1;
    const rowsPerPage = tableId === '15' ? rowsPerPage15 : rowsPerPageState;
    renderTable(tableId === '15' ? 'table15Body' : 'tableStateBody', data, 1, tableId, rowsPerPage);
    showToast(currentLanguage === 'hi' ? 'डेटा सॉर्ट किया गया' : 'Data sorted');
  }

  // Save/Load settings (extended to language & dark mode)
  function saveSettings() {
    const settings = {
      rowsPerPage15, rowsPerPageState,
      col15: {}, colState: {},
      language: currentLanguage,
      darkMode: document.body.classList.contains('dark-mode')
    };
    document.querySelectorAll('#colDropdown15 input').forEach(cb => settings.col15[cb.dataset.col] = cb.checked);
    document.querySelectorAll('#colDropdownState input').forEach(cb => settings.colState[cb.dataset.col] = cb.checked);
    localStorage.setItem('dashboardSettings', JSON.stringify(settings));
  }
  function loadSettings() {
    const saved = localStorage.getItem('dashboardSettings');
    if (saved) {
      const settings = JSON.parse(saved);
      rowsPerPage15 = settings.rowsPerPage15 || 10;
      rowsPerPageState = settings.rowsPerPageState || 10;
      document.getElementById('rowsPerPage15').value = rowsPerPage15;
      document.getElementById('rowsPerPageState').value = rowsPerPageState;
      if (settings.col15) Object.keys(settings.col15).forEach(col => { let cb = document.querySelector(`#colDropdown15 input[data-col="${col}"]`); if (cb) cb.checked = settings.col15[col]; });
      if (settings.colState) Object.keys(settings.colState).forEach(col => { let cb = document.querySelector(`#colDropdownState input[data-col="${col}"]`); if (cb) cb.checked = settings.colState[col]; });
      if (settings.language) {
        currentLanguage = settings.language;
        // apply language labels (will be done by toggleLanguage, but we call after)
      }
      if (settings.darkMode && !document.body.classList.contains('dark-mode')) {
        document.body.classList.add('dark-mode');
      } else if (!settings.darkMode && document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
      }
    }
  }

  // Reset all settings to default
  function resetAllSettings() {
    // Reset to default: all columns visible, rows 10, light mode, hindi, clear filters
    document.querySelectorAll('#colDropdown15 input').forEach(cb => cb.checked = true);
    document.querySelectorAll('#colDropdownState input').forEach(cb => cb.checked = true);
    rowsPerPage15 = 10; rowsPerPageState = 10;
    document.getElementById('rowsPerPage15').value = 10;
    document.getElementById('rowsPerPageState').value = 10;
    if (document.body.classList.contains('dark-mode')) document.body.classList.remove('dark-mode');
    if (currentLanguage !== 'hi') toggleLanguage(); // force hi
    resetFilters();
    updateColumnVisibility('15');
    updateColumnVisibility('state');
    saveSettings();
    showToast(currentLanguage === 'hi' ? 'सभी सेटिंग्स डिफ़ॉल्ट पर' : 'All settings reset');
  }

  // Chart download
  function downloadChart(chartId, filename) {
    const canvas = document.getElementById(chartId);
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/png');
    link.click();
    showToast(currentLanguage === 'hi' ? 'चार्ट डाउनलोड हुआ' : 'Chart downloaded');
  }

  // Export functions
  function exportCSV() {
    let csv = "क्र.,मद,वित्त वर्ष,योजना का नाम,राशि,स्थिति\n";
    schemes.forEach((s, i) => csv += `${i+1},"${s.fund}","${s.year}","${s.desc.replace(/"/g,'""')}",${s.amount},"${s.status}"\n`);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'panchayat_sarva_data.csv'; a.click();
    showToast('CSV ' + (currentLanguage === 'hi' ? 'डाउनलोड हुआ' : 'downloaded'));
  }
  function exportExcel() {
    const wsData = [["क्र.", "मद", "वित्त वर्ष", "योजना का नाम", "राशि", "स्थिति"]];
    schemes.forEach((s, i) => wsData.push([i+1, s.fund, s.year, s.desc, s.amount, s.status]));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "कार्य");
    XLSX.writeFile(wb, "panchayat_sarva_data.xlsx");
    showToast('Excel ' + (currentLanguage === 'hi' ? 'डाउनलोड हुआ' : 'downloaded'));
  }
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const title = currentLanguage === 'hi' ? 'ग्राम पंचायत सर्वा - कार्य सूची' : 'Gram Panchayat Sarva - Work List';
    doc.text(title, 10, 10);
    doc.setFontSize(10);
    let y = 20;
    const total = schemes.length, completed = schemes.filter(s => s.status === 'पूर्ण').length, totalAmt = schemes.reduce((a,s)=>a+s.amount,0);
    doc.text(`${currentLanguage === 'hi' ? 'कुल योजनाएँ' : 'Total Schemes'}: ${total}`, 10, y); y += 6;
    doc.text(`${currentLanguage === 'hi' ? 'पूर्ण' : 'Completed'}: ${completed}`, 10, y); y += 6;
    doc.text(`${currentLanguage === 'hi' ? 'कुल राशि' : 'Total Amount'}: ${formatMoney(totalAmt)}`, 10, y); y += 10;
    schemes.slice(0, 20).forEach((s,i) => {
      let line = `${i+1}. ${s.fund} (${s.year}) - ${s.desc.substring(0,50)}...`;
      doc.text(line, 10, y); y += 7;
      if (y > 280) { doc.addPage(); y = 20; }
    });
    doc.save('panchayat_sarva.pdf');
    showToast('PDF ' + (currentLanguage === 'hi' ? 'डाउनलोड हुआ' : 'downloaded'));
  }

  // Dark mode & language
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    renderCharts(); updateMetrics(); saveSettings();
    showToast(currentLanguage === 'hi' ? 'डार्क मोड टॉगल' : 'Dark mode toggled');
  }
  function toggleLanguage() {
    currentLanguage = currentLanguage === 'hi' ? 'en' : 'hi';
    // update all text labels (omitted for brevity, but same as previous version)
    // ... (full translation as before)
    // For simplicity, we show only essential updates, but in real code all labels would change.
    document.getElementById('langText').innerText = currentLanguage === 'hi' ? 'English' : 'हिंदी';
    document.getElementById('darkModeText').innerText = currentLanguage === 'hi' ? 'डार्क मोड' : 'Dark Mode';
    document.getElementById('mainHeading').innerText = currentLanguage === 'hi' ? '15वीं वित्त + षष्टम राज्य वित्त' : '15th Finance + 6th State Finance';
    document.getElementById('totalSchemesLabel').innerText = currentLanguage === 'hi' ? 'कुल योजनाएँ' : 'Total Schemes';
    document.getElementById('completedSchemesLabel').innerText = currentLanguage === 'hi' ? 'पूर्ण कार्य' : 'Completed';
    document.getElementById('progressSchemesLabel').innerText = currentLanguage === 'hi' ? 'प्रगति पर' : 'In Progress';
    document.getElementById('totalAmountLabel').innerText = currentLanguage === 'hi' ? 'कुल परिव्यय' : 'Total Expenditure';
    document.querySelector('.budgetTitle').innerText = currentLanguage === 'hi' ? 'बजट उपयोग' : 'Budget Usage';
    document.querySelector('.topProjectsTitle').innerText = currentLanguage === 'hi' ? 'टॉप 5 योजनाएँ (राशि)' : 'Top 5 Schemes (Amount)';
    document.querySelector('.yearlySuccessTitle').innerText = currentLanguage === 'hi' ? 'वर्षवार सफलता' : 'Yearly Success';
    document.getElementById('pieTitle').innerText = currentLanguage === 'hi' ? 'फंड वार वितरण' : 'Fund-wise Distribution';
    document.querySelector('.filterAll').innerText = currentLanguage === 'hi' ? 'सभी' : 'All';
    document.querySelector('.filterComplete').innerText = currentLanguage === 'hi' ? 'पूर्ण' : 'Complete';
    document.querySelector('.filterProgress').innerText = currentLanguage === 'hi' ? 'प्रगति पर' : 'Progress';
    document.querySelector('.resetLabel').innerText = currentLanguage === 'hi' ? 'रीसेट' : 'Reset';
    document.getElementById('barTitle').innerText = currentLanguage === 'hi' ? 'वित्त वर्षानुसार कार्य' : 'Works by Year';
    document.getElementById('summaryTitle').innerText = currentLanguage === 'hi' ? 'निष्पादन' : 'Performance';
    document.getElementById('legendCompleteLabel').innerText = currentLanguage === 'hi' ? 'पूर्ण' : 'Completed';
    document.getElementById('legendProgressLabel').innerText = currentLanguage === 'hi' ? 'प्रगति' : 'Progress';
    document.getElementById('table15Title').innerText = currentLanguage === 'hi' ? '15वीं वित्त आयोग' : '15th Finance Commission';
    document.getElementById('tableStateTitle').innerText = currentLanguage === 'hi' ? 'षष्टम राज्य वित्त' : '6th State Finance';
    document.getElementById('rowsLabel15').innerText = currentLanguage === 'hi' ? 'पंक्तियाँ:' : 'Rows:';
    document.getElementById('rowsLabelState').innerText = currentLanguage === 'hi' ? 'पंक्तियाँ:' : 'Rows:';
    document.getElementById('printLabel').innerText = currentLanguage === 'hi' ? 'प्रिंट' : 'Print';
    document.getElementById('modalTitle').innerText = currentLanguage === 'hi' ? 'योजना का विवरण' : 'Project Details';
    document.getElementById('modalFundLabel').innerText = currentLanguage === 'hi' ? 'मद:' : 'Fund:';
    document.getElementById('modalYearLabel').innerText = currentLanguage === 'hi' ? 'वित्त वर्ष:' : 'Year:';
    document.getElementById('modalDescLabel').innerText = currentLanguage === 'hi' ? 'योजना का नाम:' : 'Description:';
    document.getElementById('modalAmountLabel').innerText = currentLanguage === 'hi' ? 'राशि:' : 'Amount:';
    document.getElementById('modalStatusLabel').innerText = currentLanguage === 'hi' ? 'स्थिति:' : 'Status:';
    document.getElementById('amountRangeLabel').innerText = currentLanguage === 'hi' ? 'राशि सीमा :' : 'Amount Range :';
    document.getElementById('minAmountLabel').innerText = currentLanguage === 'hi' ? 'न्यूनतम' : 'Min';
    document.getElementById('maxAmountLabel').innerText = currentLanguage === 'hi' ? 'अधिकतम' : 'Max';
    document.getElementById('applyFilterBtn').innerText = currentLanguage === 'hi' ? 'लागू करें' : 'Apply';
    document.getElementById('clearFilterBtn').innerText = currentLanguage === 'hi' ? 'हटाएँ' : 'Clear';
    document.getElementById('trendTitle').innerText = currentLanguage === 'hi' ? 'वर्षवार व्यय (₹)' : 'Yearly Expenditure (₹)';
    updateMetrics(); renderCharts(); filterData(); saveSettings();
    showToast(currentLanguage === 'hi' ? 'भाषा बदली' : 'Language switched');
  }

  // Modal
  function showProjectModal(fund, year, desc, amount, status) {
    document.getElementById('modalFund').innerText = fund;
    document.getElementById('modalYear').innerText = year;
    document.getElementById('modalDesc').innerText = desc;
    document.getElementById('modalAmount').innerText = formatMoney(amount);
    document.getElementById('modalStatus').innerText = status;
    document.getElementById('projectModal').classList.add('show');
  }
  function closeModal() { document.getElementById('projectModal').classList.remove('show'); }

  // Event listeners
  document.getElementById('searchInput').addEventListener('input', () => { currentPage15 = 1; currentPageState = 1; filterData(); });
  document.getElementById('yearFilter').addEventListener('change', () => { currentPage15 = 1; currentPageState = 1; filterData(); });
  document.querySelectorAll('.pill').forEach(p => p.addEventListener('click', function (e) {
    if (e.target.tagName !== 'BUTTON') return;
    document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentPage15 = 1; currentPageState = 1; filterData();
  }));
  window.addEventListener('click', e => { if (!e.target.closest('.col-toggle')) document.querySelectorAll('.col-toggle-content').forEach(d => d.classList.remove('show')); });
  document.querySelectorAll('.col-toggle-content input').forEach(cb => cb.addEventListener('change', function () {
    updateColumnVisibility(this.closest('.col-toggle-content').id === 'colDropdown15' ? '15' : 'state');
  }));

  // Initialize
  loadSettings();
  setLastUpdated();
  renderCharts();
  filterData();  // this calls updateMetrics and tables
  updateClock();

  // Expose functions
  window.sortTable = sortTable; window.exportCSV = exportCSV; window.exportExcel = exportExcel; window.exportPDF = exportPDF;
  window.toggleDarkMode = toggleDarkMode; window.toggleFullScreen = toggleFullScreen; window.toggleColDropdown = toggleColDropdown;
  window.changePage = changePage; window.changeRowsPerPage = changeRowsPerPage; window.resetFilters = resetFilters;
  window.toggleLanguage = toggleLanguage; window.showProjectModal = showProjectModal; window.closeModal = closeModal;
  window.applyAmountFilter = applyAmountFilter; window.clearAmountFilter = clearAmountFilter;
  window.resetAllSettings = resetAllSettings; window.downloadChart = downloadChart;
</script>
</body>
</html>